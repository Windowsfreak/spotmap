/*! spotmap - v0.2.1 - 2018-03-24
* https://github.com/windowsfreak/spotmap
* Copyright (c) 2018 Bj√∂rn Eberhardt; Licensed MIT */

"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(i){i.ready=[],i.runLater=function(){return(i.ready=i.ready.map(function(e){return"function"==typeof e&&e()}).filter(function(e){return e})).length&&i.runLater()},i._=function(e){return"#"===e[0]?document.getElementById(e.slice(1)):document.querySelectorAll(e)},i.strip=function(e){var t=document.createElement("DIV");return t.innerHTML=e,t.textContent||t.innerText||""},i.t=function(e,t){return lang[e]||console.log("MISSING: "+e),lang[e]?lang[e].replace("\\1",t):"MISSING: "+e},i.setLang=function(e){localStorage.setItem("lang",e),location.reload()},i.t_html=function(){var e=!0,t=!1,o=void 0;try{for(var n,a=i._("*")[Symbol.iterator]();!(e=(n=a.next()).done);e=!0){var r=n.value;r.getAttribute("data-translate")&&(r[0<=["input","textarea"].indexOf(r.tagName.toLowerCase())?"placeholder":"innerHTML"]=i.t(r.getAttribute("data-translate")))}}catch(e){t=!0,o=e}finally{try{!e&&a.return&&a.return()}finally{if(t)throw o}}},i.t_html()}(window);var Form={};!function(o){ready.push(function(){Nav.events.form_show=function(){_("#map").style.display="block",_("#map").className="half",Maps.map.setCenter(Maps.marker.getPosition()),google.maps.event.trigger(Maps.map,"resize"),google.maps.event.addListenerOnce(Maps.map,"idle",function(){google.maps.event.trigger(Maps.map,"resize"),Maps.map.setCenter(Maps.marker.getPosition())})},Nav.events.form_hide=function(e){_("#map").className="",localStorage.getItem("form_text")&&!e&&Nav.success(t("draft_saved"))}}),o.add_here=function(e){Maps.newMarker(Spot.spot,!0),o.add(e)},o.add=function(e){var o={spot:t("new_spot"),group:t("new_group"),event:t("new_event")};_("#form-type").innerText=o[e],Spot.marker={lat:Maps.marker.getPosition().lat(),lng:Maps.marker.getPosition().lng(),type:e},Nav.goTab("form")},o.backup=function(){localStorage.setItem("form_title",_("#form-title").value),localStorage.setItem("form_text",_("#form-text").value),Maps.marker&&(localStorage.setItem("form_lat",Maps.marker.getPosition().lat()),localStorage.setItem("form_lng",Maps.marker.getPosition().lng())),Spot.marker&&localStorage.setItem("form_type",Spot.marker.type)},o.restore=function(){localStorage.getItem("form_text")&&(_("#form-title").value=localStorage.getItem("form_title"),_("#form-text").value=localStorage.getItem("form_text"),Spot.marker={lat:parseFloat(localStorage.getItem("form_lat")),lng:parseFloat(localStorage.getItem("form_lng")),type:localStorage.getItem("form_type")},window.panToPosition=!1,Maps.newMarker(Spot.marker,!0),Maps.map.panTo(Spot.marker),o.add(Spot.marker.type),google.maps.event.addListenerOnce(Maps.map,"idle",function(){Maps.map.panTo(Maps.marker.getPosition())}),Nav.success(t("draft_restored")))},o.remove=function(e){(e||confirm(t("draft_delete_confirm")))&&(localStorage.removeItem("form_title"),localStorage.removeItem("form_text"),localStorage.removeItem("form_lat"),localStorage.removeItem("form_lng"),localStorage.removeItem("form_type"),_("#form-title").value="",_("#form-text").value="",Nav.goTab("map",0),e||Nav.success(t("draft_deleted")))},o.save=function(){Http.get("//www.parkour.org/rest/session/token",void 0,{Authorization:!1}).then(function(e){Nav.success(t("in_progress")),Http.post("//www.parkour.org/entity/node?_format=hal_json",JSON.stringify({_links:{type:{href:"https://www.parkour.org/rest/type/node/"+Spot.marker.type}},type:[{target_id:Spot.marker.type}],title:[{value:_("#form-title").value}],body:[{value:_("#form-text").value}],field_location:[{lat:Spot.marker.lat,lon:Spot.marker.lng,value:"POINT ("+Spot.marker.lng+" "+Spot.marker.lat+")"}]}),{"Content-Type":"application/hal+json","X-CSRF-Token":e.message}).then(function(e){Nav.success(t("node_added")),location.href="//www.parkour.org/de/node/"+Spot.find("nid|\\d+|value",e)[0]+"/edit",o.remove(!0)},function(e){return Nav.error(t(403===e.status||401===e.status?"error_forbidden":"error_add_node"))})},function(){return Nav.error(t("error_add_node"))})}}(Form);var Geohash={};!function(c){c.BITS=[16,8,4,2,1],c.BASE32="0123456789bcdefghjkmnpqrstuvwxyz",c.NEIGHBORS={right:{even:"bc01fg45238967deuvhjyznpkmstqrwx"},left:{even:"238967debc01fg45kmstqrwxuvhjyznp"},top:{even:"p0r21436x8zb9dcf5h7kjnmqesgutwvy"},bottom:{even:"14365h7k9dcfesgujnmqp0r2twvyx8zb"}},c.BORDERS={right:{even:"bcfguvyz"},left:{even:"0145hjnp"},top:{even:"prxz"},bottom:{even:"028b"}},c.NEIGHBORS.bottom.odd=c.NEIGHBORS.left.even,c.NEIGHBORS.top.odd=c.NEIGHBORS.right.even,c.NEIGHBORS.left.odd=c.NEIGHBORS.bottom.even,c.NEIGHBORS.right.odd=c.NEIGHBORS.top.even,c.BORDERS.bottom.odd=c.BORDERS.left.even,c.BORDERS.top.odd=c.BORDERS.right.even,c.BORDERS.left.odd=c.BORDERS.bottom.even,c.BORDERS.right.odd=c.BORDERS.top.even,c.refineInterval=function(e,t,o){return e[t&o?0:1]=(e[0]+e[1])/2},c.adjacent=function(e,t){var o=(e=e.toLowerCase()).charAt(e.length-1),n=e.length%2?"odd":"even",a=e.substring(0,e.length-1);return(-1!==c.BORDERS[t][n].indexOf(o)?c.adjacent(a,t):a)+c.BASE32[c.NEIGHBORS[t][n].indexOf(o)]},c.decode=function(e){var t=1,o=[],n=[];o[0]=-90,o[1]=90,n[0]=-180;n[1]=180;for(var a=0;a<e.length;a++)for(var r=e[a],i=c.BASE32.indexOf(r),s=0;s<5;s++){var l=c.BITS[s];t?(2,c.refineInterval(n,i,l)):(2,c.refineInterval(o,i,l)),t=!t}return o[2]=(o[0]+o[1])/2,n[2]=(n[0]+n[1])/2,{lat:o,lng:n}},c.encode=function(e,t){var o=1,n=[],a=[],r=0,i=0,s="";for(n[0]=-90,n[1]=90,a[0]=-180,a[1]=180;s.length<12;){if(o){var l=(a[0]+a[1])/2;l<t?(i|=c.BITS[r],a[0]=l):a[1]=l}else{var p=(n[0]+n[1])/2;p<e?(i|=c.BITS[r],n[0]=p):n[1]=p}o=!o,r<4?r++:(s+=c.BASE32[i],i=r=0)}return s}}(Geohash);var Geotile={};!function(S){var k={},b=[[180,360],[45,45],[5.625,11.25],[1.40625,1.40625],[.17578125,.3515625],[.0439453125,.0439453125],[.0054931640625,.010986328125],[.001373291015625,.001373291015625],[.000171661376953125,.00034332275390625],[4291534423828125e-20,4291534423828125e-20],[5364418029785156e-21,10728836059570312e-21],[1341104507446289e-21,1341104507446289e-21],[1.6763806343078613e-7,3.3527612686157227e-7]];S.onlyUnique=function(e,t,o){return o.indexOf(e)===t},S.extend=function(e,t){var o=e.slice(0),n=!0,a=!1,r=void 0;try{for(var i,s=o[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var l=i.value;e.push(Geohash.adjacent(l,t))}}catch(e){a=!0,r=e}finally{try{!n&&s.return&&s.return()}finally{if(a)throw r}}return e.filter(S.onlyUnique)},S.filter=function(e,t){var o={};for(var n in e)if(e.hasOwnProperty(n)){var a=t(n,e[n]);void 0!==a&&(o[n]=a)}return o},S.loadBounds=function(e,o){var n=void 0,a={lat:(n=e.lat?e:{lat:[(n={sw:e.getSouthWest(),ne:e.getNorthEast()}).sw.lat(),n.ne.lat()],lng:[n.sw.lng(),n.ne.lng()]}).lat.slice(0),lng:n.lng.slice(0)};a.lng[1]<a.lng[0]&&(a.lng[1]+=360),360<a.lng[0]+a.lng[1]&&(a.lng[1]-=360,a.lng[0]-=360);var r=[a.lat[1]-a.lat[0],a.lng[1]-a.lng[0]],i=void 0,s=Math.min(r[0],r[1]);(5<(i=23<s?0:2.8<s?1:.7<s?2:.087<s?3:.022<s?4:.0027<s?5:6)||i<0)&&(i=-1);for(var l=12;0<l--&&!(b[l][0]>r[0]/3&&b[l][1]>r[1]/3););l++;for(var p=void 0;0<l;){var c=b[--l],u=Geohash.encode((a.lat[0]+a.lat[1])/2,(a.lng[0]+a.lng[1])/2).substring(0,l);p=[u];var d=Geohash.decode(u);if(d.lat[0]>n.lat[0]){if(d.lat[0]-c[0]>n.lat[0])continue;p=S.extend(p,"bottom")}if(d.lat[1]<n.lat[1]){if(d.lat[1]+c[0]<n.lat[1])continue;p=S.extend(p,"top")}if(d.lng[0]>n.lng[0]){if(d.lng[0]-c[1]>n.lng[0])continue;p=S.extend(p,"left")}if(d.lng[1]<n.lng[1]){if(d.lng[1]+c[1]<n.lng[1])continue;p=S.extend(p,"right")}break}k[i]||(k[i]={});var g={},m=!0,f=!1,v=void 0;try{for(var h,y=p[Symbol.iterator]();!(m=(h=y.next()).done);m=!0){var _=h.value;g[_]=k[i][_]}}catch(e){f=!0,v=e}finally{try{!m&&y.return&&y.return()}finally{if(f)throw v}}var w=Object.keys(S.filter(g,function(e,t){return void 0===t?e:void 0})).map(function(e){return e});return w.length&&Http.get("//map.parkour.org/query5j.php",{tiles:w.join(","),zoom:i},{Authorization:!1}).then(function(e){Object.assign(k[i],e),Object.assign(g,e),o(g)},function(){return Nav.error(t("error_load_spotmap"))}),o(g),g}}(Geotile);var Help={};!function(o){ready.push(function(){return Nav.events.help_show=function(e){return o.previous="help"!==e?e:o.previous}}),o.show=function(e){Http.get("./static/"+e+"_"+l+".json",void 0,{Authorization:!1}).then(function(e){_("#help-title").innerText=t("no_title");var o=!0,n=!1,a=void 0;try{for(var r,i=Spot.find("title",e)[Symbol.iterator]();!(o=(r=i.next()).done);o=!0){var s=r.value;_("#help-title").innerText=s}}catch(e){n=!0,a=e}finally{try{!o&&i.return&&i.return()}finally{if(n)throw a}}_("#help-body").innerText=t("no_body");var l=!0,p=!1,c=void 0;try{for(var u,d=Spot.find("body",e)[Symbol.iterator]();!(l=(u=d.next()).done);l=!0){var g=u.value;_("#help-body").innerHTML=g}}catch(e){p=!0,c=e}finally{try{!l&&d.return&&d.return()}finally{if(p)throw c}}Nav.goTab("help")},function(e){return Nav.error(t("no_results_found"))})}}(Help);var Http={};!function(n){n.b64a=function(e){return btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)}))},n.getUser=function(){return localStorage.getItem("d8_user")},n.getCredentials=function(){return localStorage.getItem("d8_auth")||"Basic Og=="},n.setCredentials=function(e,t){localStorage.setItem("d8_user",e),localStorage.setItem("d8_auth","Basic "+n.b64a(e+":"+t))},n.deleteCredentials=function(){localStorage.removeItem("d8_user"),localStorage.removeItem("d8_auth")},n.http=function(r,i,s){var l=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{};return!1===l.Authorization?delete l.Authorization:l.user?(l.Authorization="Basic "+n.b64a(l.user+":"+l.pass),delete l.user,delete l.pass):i.match(/^(https?:)?\/\/(www\.)?map\.parkour\.org\/?/)&&(l.Authorization=n.getCredentials()),new Promise(function(o,n){var a=new XMLHttpRequest;a.open(r,i),a.onload=function(){if(200<=this.status&&this.status<300)try{o(JSON.parse(a.response))}catch(e){Nav.error(t("error_server_request")),o({method:r,url:i,params:s,headers:l,status:this.status,statusText:a.statusText,message:a.response})}else a.onerror()},a.onerror=function(){Nav.error(t("error_server_request"));var e={method:r,url:i,params:s,headers:l,status:this.status,statusText:a.statusText,message:a.response};n(e)},l&&Object.keys(l).forEach(function(e){return a.setRequestHeader(e,l[e])}),s&&"object"===(void 0===s?"undefined":_typeof(s))?a.send(Object.keys(s).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(s[e])}).join("&")):a.send(s)})},n.get=function(e,t,o){return t&&"object"===(void 0===t?"undefined":_typeof(t))?n.http("GET",e+(0<e.indexOf("?")?"&":"?")+Object.keys(t).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(t[e])}).join("&"),void 0,o):t?n.http("GET",e+(0<e.indexOf("?")?"&":"?")+t,void 0,o):n.http("GET",e,t,o)},n.post=function(e,t,o){return n.http("POST",e,t,o)},n.patch=function(e,t,o){return n.http("PATCH",e,t,o)},n.del=function(e,t,o){return n.http("REMOVE",e,t,o)}}(Http);var Login={};ready.push(function(){Nav.events.login_show=function(){null!==Http.getUser()?(Nav.goTab("logout-form"),_("#username").innerText=Http.getUser()):Nav.goTab("login-form")}}),_("#login-submit").onclick=function(){var o=_("#login-username"),n=_("#login-password");Http.setCredentials(o.value,n.value),Http.get("//map.parkour.org/api/v1/auth",null,{Authorization:!0}).then(function(e){Nav.success(t("logged_in_as",o.value)),o.value="",n.value="",Nav.events.login_show()},function(){Nav.error(t("error_login")),Http.deleteCredentials(),n.value="",n.focus()})},_("#logout-submit").onclick=function(){Http.deleteCredentials(),Nav.events.login_show()};var Maps={};!function(s){ready.push(function(){Nav.events.map_show=function(){if(window.google){var e=s.map.getCenter();google.maps.event.trigger(s.map,"resize"),s.map.setCenter(e)}},window.mapScripts=!0,window.mapLoaded&&s.initMapInternal()});var o=Date.now;s.panToPosition=!location.hash.startsWith("#map/"),s.filter=["spot","event","group"];var n=void 0;s.icons={},s.shapes={},s.setGpsObj=function(e){n&&n.setMap(null),n=new google.maps.Circle({strokeColor:"#0000FF",strokeOpacity:.4,strokeWeight:2,fillColor:"#0000FF",fillOpacity:.1,map:s.map,center:{lat:e.coords.latitude,lng:e.coords.longitude},radius:e.coords.accuracy,position:e})},s.updateGpsObj=function(e){return(!n||n.position.coords.accuracy>e.coords.accuracy||n.position.timestamp<e.timestamp-3e3)&&(s.setGpsObj(e),!0)},s.pan=function(e){var t=function(){s.map.panTo({lat:e.coords.latitude,lng:e.coords.longitude}),s.map.setZoom(e.coords.accuracy<200?17:e.coords.accuracy<500?16:e.coords.accuracy<2e3?15:13)};t(),google.maps.event.addListenerOnce(s.map,"idle",t)},s.track=function(t){"yes"===t&&(window.panToPosition=!0,Nav.goTab("map",0));var e=function(e){s.updateGpsObj(e)&&(t||Date.now()<o+1e4)&&("yes"===t||!location.hash.startsWith("#map")&&window.panToPosition)&&s.pan(e)};try{navigator.geolocation.getCurrentPosition(e,function(){return!1},{timeout:250}),navigator.geolocation.getCurrentPosition(e,function(){return!1},{enableHighAccuracy:!0})}catch(e){Nav.error("The browser is too old, Geolocation is not supported.")}},s.markers={},s.load=function(e,t){var o=new google.maps.Marker({id:e.id,map:s.map,title:""+e.title,position:{lat:e.lat,lng:e.lng},data:e,icon:e.type.startsWith("multi")?s.icons.zoom:e.type.includes("group")?s.icons.group:e.type.includes("event")?s.icons.event:s.icons.spot,shape:e.type.startsWith("multi")?s.shapes.zoom:s.shapes.spot});t.push(o),google.maps.event.addListener(o,"click",s.show)},s.show=function(e){if((!e||e.latLng||e.pixel)&&(e=this),"add"===e.data.category){if(Nav.isLite)return;s.map.panTo(e.getPosition()),s.infoWindow.setContent('\n            <button type="button" onclick="Form.add(\'spot\')">&#x2795; '+t("spot")+'</button>\n            <button type="button" onclick="Form.add(\'event\')">&#x2795; '+t("event")+'</button>\n            <button type="button" onclick="Form.add(\'group\')">&#x2795; '+t("group")+"</button>"),s.infoWindow.open(s.map,e)}else if(e.data.category.startsWith("multi"))s.infoWindow.close(),s.map.panTo(e.getPosition()),s.map.setZoom(s.map.getZoom()+2);else{var o=e.data.type.startsWith("multi")?s.icons.zoom:e.data.type.includes("group")?s.icons.group:e.data.type.includes("event")?s.icons.event:s.icons.spot;s.infoWindow.setContent("<a onclick=\"Nav.navigate('#spot/"+e.data.id+'\');"><img class="type" src="'+o.url+'">'+e.data.title+"</a>"),s.infoWindow.setPosition(e.getPosition()),s.infoWindow.open(s.map),Proximity.getCloseNodes(e.data.lat,e.data.lng)}},s.loadAll=function(e){for(var t in e)if(!s.markers[t]||e[t]&&s.markers[t].length!==e[t].length){var o=[];for(var n in e[t])s.matchesFilter(e[t][n])&&s.load(e[t][n],o);if(s.markers[t])for(var a in s.markers[t])s.markers[t][a].setMap(null);s.markers[t]=o}for(var r in s.markers)if(!e[r]){for(var i in s.markers[r])s.markers[r][i].setMap(null);delete s.markers[r]}},s.handleBoundsChanged=function(){var e=s.map.getBounds();Geotile.loadBounds(e,s.loadAll);var t=s.map.getCenter(),o="#map/"+t.lat()+"/"+t.lng()+"/"+s.map.getZoom();location.hash===o||!location.hash.startsWith("#map/")&&""!==location.hash||history.replaceState({},"","#map/"+t.lat().toFixed(5)+"/"+t.lng().toFixed(5)+"/"+s.map.getZoom())},s.initMapInternal=function(){var e=location.hash,t=new google.maps.LatLngBounds({lat:49,lng:6},{lat:55,lng:15});if(s.map=new google.maps.Map(_("#map"),{center:{lat:51.5167,lng:9.9167},zoom:7}),s.geocoder=new google.maps.Geocoder,e.startsWith("#map/")){var o=/#(\w+)\/([^/]*)\/([^/]*)(?:\/([^/]*))?/g.exec(e);s.map.setCenter({lat:parseFloat(o[2]),lng:parseFloat(o[3])}),o[4]&&s.map.setZoom(parseInt(o[4],10))}else window.panToPosition?s.map.fitBounds(t):(s.map.setZoom(15),void 0!==Spot.spot.lat&&s.map.setCenter(Spot.spot));google.maps.event.addDomListener(window,"resize",function(){var e=s.map.getCenter();google.maps.event.trigger(s.map,"resize"),s.map.setCenter(e)}),google.maps.event.addListener(s.map,"bounds_changed",s.handleBoundsChanged),google.maps.event.addListener(s.map,"click",s.newMarker);var n=document.createElement("div");s.createFilter(n),n.index=1,s.map.controls[google.maps.ControlPosition.LEFT_TOP].push(n),s.icons.event={url:"images/green.png",size:new google.maps.Size(32,32),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(15,31)},s.icons.group={url:"images/purple.png",size:new google.maps.Size(32,32),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(15,31)},s.icons.spot={url:"images/logo32.png",size:new google.maps.Size(32,32),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(15,31)},s.shapes.spot={coords:[15,0,31,7,15,31,0,7,15,0],type:"poly"},s.icons.zoom={url:"images/multi.png",size:new google.maps.Size(24,24),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(8,8)},s.shapes.zoom={coords:[11,0,14,1,16,3,18,5,18,13,18,15,24,20,24,23,15,19,7,18,1,15,0,7,3,2,7,0,11,0],type:"poly"},s.icons.crosshair={url:"images/crosshair.png",size:new google.maps.Size(49,49),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(24,24)},s.infoWindow=new google.maps.InfoWindow({content:"Some address here..",maxWidth:500,pixelOffset:new google.maps.Size(0,-31)}),s.track(!0),Form.restore()},s.geocode=function(e){s.geocoder.geocode({address:e},function(e,o){o===google.maps.GeocoderStatus.OK?(s.newMarker({latLng:e[0].geometry.location},!0),s.map.setCenter(e[0].geometry.location),s.map.setZoom(15)):Nav.error(t("error_geocode")+" "+o)})},s.newMarker=function(e,o){e.latLng||(e.latLng={lat:e.lat,lng:e.lng}),!o&&Nav.isLite||(!o&&s.map.getZoom()<14?Nav.success(t("zoom")):(s.marker?s.marker.setPosition(e.latLng):(s.marker=new google.maps.Marker({position:e.latLng,map:s.map,title:t("new_marker"),icon:s.icons.crosshair,draggable:!Nav.isLite,data:{category:"add"}}),s.marker.addListener("drag",s.dragMarker),s.marker.addListener("dragend",s.endMarker),s.marker.addListener("click",s.show),s.show(s.marker)),s.dragMarker(),Form.backup()))},s.dragMarker=function(e){return Nav.success(t("position")+": "+s.marker.getPosition().lat().toFixed(5)+" "+s.marker.getPosition().lng().toFixed(5))},s.endMarker=function(e){s.map.panTo(s.marker.getPosition()),Form.backup()},s.clickMarker=function(e){return s.show(s.marker)},s.createFilter=function(e){e.className="filterDiv";var o=document.createElement("div");o.className="filterBtn",o.innerHTML="&#9881;",e.appendChild(o);var n=document.createElement("div");n.className="filterBox vanish",e.appendChild(n),n.innerHTML='Zeige:<br />\n            <span class="yes" id="filter-spot" onclick="Maps.toggleFilter(\'spot\')">'+t("spot")+'</span><br />\n            <span class="yes" id="filter-event" onclick="Maps.toggleFilter(\'event\')">'+t("event")+'</span><br />\n            <span class="yes" id="filter-group" onclick="Maps.toggleFilter(\'group\')">'+t("group")+"</span>",o.addEventListener("click",function(){var e=_(".filterBox")[0];e.className="filterBox"===e.className?"filterBox vanish":"filterBox"})},s.toggleFilter=function(e){var t=_("#filter-"+e);if(t.className="yes"===t.className?"no":"yes","yes"===t.className)s.filter.includes(e)||s.filter.push(e);else{var o=s.filter.indexOf(e);-1!==o&&s.filter.splice(o,1)}s.loadAll([]),s.handleBoundsChanged()},s.matchesFilter=function(e){var t=!0,o=!1,n=void 0;try{for(var a,r=s.filter[Symbol.iterator]();!(t=(a=r.next()).done);t=!0){var i=a.value;if(-1!==e.type.indexOf(i))return!0}}catch(e){o=!0,n=e}finally{try{!t&&r.return&&r.return()}finally{if(o)throw n}}return!1}}(Maps);var Nav={};!function(l){l.events={},l.isLite=!1,l.openTab=function(e,t){for(var o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:_("#"+e).parentNode,n=_("section"),a=void 0,r=0;r<n.length;r++)n[r].parentNode===o&&("block"===n[r].style.display&&(a=n[r].id,console.log("Hiding  "+n[r].id),l.events[n[r].id+"_hide"]&&l.events[n[r].id+"_hide"](e===n[r].id)),n[r].style.display="none");if(t){for(var i=_("button"),s=0;s<i.length;s++)i[s].className=i[s].className.replace(" active","");t.currentTarget.className+=" active"}_("#"+e).style.display="block",console.log("Showing "+e),l.events[e+"_show"]&&l.events[e+"_show"](a)},l.goTab=function(e,t){return l.openTab(e,void 0!==t?{currentTarget:_("button")[t]}:void 0)},l.resetTab=function(){return l.navigate("")},l.notice=function(e,t){window.noticeHideTimeout&&l.noticeHide(),_("#notice").className=t+" show",_("#notice-text").innerText=e,window.noticeHideTimeout=window.setTimeout(l.noticeHide,4e3)},l.error=function(e){return l.notice(e,"error")},l.success=function(e){return l.notice(e,"success")},l.noticeHide=function(e){_("#notice").className+=e?" vanish":" hide",window.noticeHideTimeout&&(window.clearTimeout(window.noticeHideTimeout),delete window.noticeHideTimeout)},l.navigate=function(e){if("string"!=typeof e){if((e=location.hash).startsWith("#event/")||e.startsWith("#group/")||e.startsWith("#move/")||e.startsWith("#page/")||e.startsWith("#post/")||e.startsWith("#spot/")){var t=/#(\w+)\/(\d+)(?:\/(.*))?/g.exec(e);"lite"===t[3]&&(_("body")[0].className="lite",l.isLite=!0),Spot.loadSpot(t[2])}else if(e.startsWith("#login"))l.goTab("login",2);else if(e.startsWith("#search"))l.goTab("search",1),e.startsWith("#search/")&&(_("#search-text").value=/#(\w+)\/(.*)/g.exec(e)[2],Search.loadSearch());else if((""===e||e.startsWith("#map/"))&&(l.goTab("map",0),e.startsWith("#map/"))){var o=/#(\w+)\/([^/]*)\/([^/]*)(?:\/([^/]*))?/g.exec(e);Map.map&&(Map.map.panTo({lat:parseFloat(o[2]),lng:parseFloat(o[3])}),o[4]&&Map.map.setZoom(parseInt(o[4],10)))}}else location.hash=e},l.goTab("map",0),_("body")[0].onkeyup=function(e){return 27!==e.which||l.goTab("map",0)},ready.push(function(){return function(){document.addEventListener("DOMContentLoaded",l.navigate,!1),window.onhashchange=l.navigate}})}(Nav);var Proximity={getCloseNodes:function(e,t){var p={lat:[e-1e-4,e+1e-4],lng:[t-1e-4,t+1e-4]};Geotile.loadBounds(p,function(e){var t=[],o={spot:0,event:1,group:2};for(var n in e)for(var a in e[n]){var r=e[n][a];r.lat>p.lat[0]&&r.lat<p.lat[1]&&r.lng>p.lng[0]&&r.lng<p.lng[1]&&t.push(r)}var i="";for(var s in t.sort(function(e,t){return o[e.type]-o[t.type]}),t){var l=t[s];i+='<a class="entry" onclick="Nav.navigate(\'#spot/'+l.id+'\');"><img class="type" src="'+Maps.icons[l.type].url+'">'+l.title+"</a>"}""!==i&&Maps.infoWindow.setContent(i)})}},Search={};!function(o){var n={};_("#search-submit").onclick=function(){var e=_("#search-text").value;Nav.navigate((/^(0|[1-9]\d*)$/.test(e)?"#spot/":"#search/")+e)},_("#search-geocode").onclick=function(){var e=_("#search-text").value;Maps.geocode(e),Nav.navigate("")},o.loadSearch=function(){var e=_("#search-text").value;/^(0|[1-9]\d*)$/.test(e)?Nav.navigate("#spot/"+e):(n.data={search:e,limit:25},Http.get("//map.parkour.org/api/v1/spots/search",n.data,{Authorization:!1}).then(o.showPage))},o.showPage=function(e){var o='<div class="grid">';0===e.length&&(o+=t("no_results_found"));var n=!0,a=!1,r=void 0;try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var l=i.value;o+="<article onclick=\"Nav.navigate('#spot/"+l.id+"');\">",l.p0&&(o+='<div class="in-place cover" style="background-image: url(//map.parkour.org/images/spots/thumbnails/320px/'+l.p0+');"></div>'),o+='<div class="in-place title">',o+="<h1><span>"+strip(l.title)+"</span></h1>",o+="<p><span>"+strip(l.description).substring(0,100)+"</span></p>",o+="</div>",o+="</article>"}}catch(e){a=!0,r=e}finally{try{!n&&s.return&&s.return()}finally{if(a)throw r}}o+="</div>",_("#search-page").innerHTML=o}}(Search);var Spot={};!function(c){c.spot={},ready.push(function(){return Nav.events.spot_hide=function(){return _("#map").className=""}}),c.loadSpot=function(p){Http.get("//map.parkour.org/api/v1/spot/"+p,null,{Authorization:!1}).then(function(e){c.spot={id:p,type:e.spot.type,url_alias:e.spot.url_alias},_("#spot-title").innerText=e.spot.title||t("no_title"),_("#spot").className="spot-type-"+e.spot.type,_("#spot-type").innerText=t(e.spot_type_detailed);var o="",n=new Date(1e3*e.spot.created).toLocaleString();o=e.spot.user_id?t("node_created_by",e.spot.user_id)+" "+t("node_created_by_at",n):""+t("node_created_at",n),e.spot.changed>e.spot.created&&(o+=""+t("node_changed_at",new Date(1e3*e.spot.changed).toLocaleString())),_("#spot-meta").innerText=o,_("#spot-body").innerHTML=e.spot.description||t("no_body"),_("#spot-lat").innerHTML=e.spot.lat,_("#spot-lng").innerHTML=e.spot.lng,c.spot.lat=parseFloat(e.spot.lat),c.spot.lng=parseFloat(e.spot.lng);var a=!(o=""),r=!1,i=void 0;try{for(var s,l=e.images[Symbol.iterator]();!(a=(s=l.next()).done);a=!0){o+='<img src="//map.parkour.org/images/spots/thumbnails/320px/'+s.value.filename+'" />'}}catch(e){r=!0,i=e}finally{try{!a&&l.return&&l.return()}finally{if(r)throw i}}_("#spot-images").innerHTML=o||t("no_images"),Nav.goTab("spot"),c.spot.lat&&c.spot.lng?(_("#spot-geo").style.display="block",_("#spot-map").style.display="inline",_("#spot-maps-form").style.display="inline",_(".add-here").forEach(function(e){return e.style.display="inline-block"}),_("#spot-maps-formdata").value=c.spot.lat+","+c.spot.lng,_("#map").style.display="block",_("#map").className="half",Maps.panToPosition=!1,google.maps.event.addListenerOnce(Maps.map,"idle",function(){google.maps.event.trigger(Maps.map,"resize"),Maps.map.setCenter(c.spot),Maps.map.setZoom(15)}),console.log(c.spot),Nav.isLite&&Maps.newMarker(c.spot,!0),google.maps.event.trigger(Maps.map,"resize"),Maps.map.setCenter(c.spot),Maps.map.setZoom(15)):(_("#spot-geo").style.display="none",_("#spot-map").style.display="none",_("#spot-maps-form").style.display="none",_(".add-here").forEach(function(e){return e.style.display="none"}))},function(e){return Nav.error(t("error_load_spot"))})},c.find=function(e,t){var o=[t];e=e.split("|");var n=!0,a=!1,r=void 0;try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var l=i.value,p=new RegExp("^"+l+"$"),c=[],u=!0,d=!1,g=void 0;try{for(var m,f=o[Symbol.iterator]();!(u=(m=f.next()).done);u=!0){var v=m.value;for(var h in v)v.hasOwnProperty(h)&&p.test(h)&&c.push(v[h])}}catch(e){d=!0,g=e}finally{try{!u&&f.return&&f.return()}finally{if(d)throw g}}o=c}}catch(e){a=!0,r=e}finally{try{!n&&s.return&&s.return()}finally{if(a)throw r}}return o},_("#spot-map").onclick=function(){Nav.navigate(""),Maps.map.setCenter(c.spot),Maps.map.setZoom(15)},_("#spot-web").onclick=function(){location.href="//map.parkour.org/"+c.spot.type+"/"+c.spot.url_alias}}(Spot),window.runLater(),window.addEventListener("load",function(){return setTimeout(function(){return window.scrollTo(0,1)},0)});